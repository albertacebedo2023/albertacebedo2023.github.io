<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>AR Click GLB REAL DEPTH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { margin:0; overflow:hidden; background:black; }
video {
  position:fixed;
  top:0; left:0;
  width:100%;
  height:100%;
  object-fit:cover;
  z-index:-1;
}
canvas { position:fixed; top:0; left:0; }
</style>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
</head>

<body>

<video id="cam" autoplay playsinline></video>

<script>

// ===== CAMARA REAL =====
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" },
  audio:false
}).then(s => cam.srcObject = s);


// ===== THREE =====
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.01, 5000);
camera.position.set(0, 1.6, 0);

const renderer = new THREE.WebGLRenderer({alpha:true, antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);


// ===== LUCES =====
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 2));
const sun = new THREE.DirectionalLight(0xffffff, 2);
sun.position.set(10,50,10);
scene.add(sun);


// ===== SUELO INVISIBLE GRANDE =====
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(5000,5000), // ðŸ”¥ MUY GRANDE
  new THREE.MeshBasicMaterial({visible:false})
);
ground.rotation.x = -Math.PI/2;
ground.position.y = 0;
scene.add(ground);


// ===== MODELO =====
let modelTemplate;
new THREE.GLTFLoader().load("tanjiro_funko_pop.glb", gltf=>{
  modelTemplate = gltf.scene;
  modelTemplate.scale.set(0.5,0.5,0.5);
  console.log("Modelo OK");
});


// ===== LIMITE DE MODELOS =====
const modelos = [];
const MAX_MODELOS = 7;


// ===== CLICK =====
const raycaster = new THREE.Raycaster();
const mouse = new THREE.Vector2();

window.addEventListener("pointerdown", e => {

  if(!modelTemplate) return;

  mouse.x = (e.clientX / innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / innerHeight) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  const hits = raycaster.intersectObject(ground);

  if(hits.length){

    // Crear modelo
    const obj = modelTemplate.clone(true);
    obj.position.copy(hits[0].point);
    obj.rotation.y = Math.random() * Math.PI * 2;
    scene.add(obj);

    modelos.push(obj);

    // Limitar a 5
    if(modelos.length > MAX_MODELOS){
      const viejo = modelos.shift(); // quitar primero
      scene.remove(viejo);
      console.log("Modelo eliminado (lÃ­mite alcanzado)");
    }

    console.log("Modelos actuales:", modelos.length);
  }
});


// ===== LOOP =====
function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();


// ===== RESIZE =====
window.addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

</script>
</body>
</html>
